{% extends "base.html" %}

{% block title %}
| Scan QR
{% endblock %}

{% block content %}
<div class="container-lg h-100">
    <div id="alert-section"></div>
    <div class="d-flex flex-row">
        <a href="/student/" role="button" class="btn bg-transparent rounded border border-0">
            <span class="material-symbols-outlined">
                arrow_back_ios_new
            </span>
        </a>
        <div class="col d-block pe-3 me-3">
            <p class="fs-3 fw-medium mb-0 text-center">
                Scan QR
            </p>
            <div class="d-md-none d-flex justify-content-center w-100">
                <div class="border border-secondary border-1 w-50"></div>
            </div>
        </div>
    </div>
    <div class="container h-100 d-flex flex-column align-items-center mt-3 gap-2">
        <div class="row">
            <p class="fw-lighter text-center">
                Align the QR code within frame.
            </p>
            <div id="qr-result"></div>
        </div>
        <div class="d-flex flex-column justify-content-center overflow-x-hidden">
            <video id="video" style="width:250px;height:250px; object-fit: cover;"></video>
        </div>
        <div class="d-flex justify-content-center"><button type="button" onclick="()=>scanQRCode({{ student_number }})"
                class="btn justify-content-center d-flex align-items-center btn-outline-secondary">Scan
                <span class="material-symbols-outlined"> photo_camera </span></button>
        </div>
        <canvas id="canvas" width="250" height="250"></canvas>
    </div>

</div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.0/dist/jsQR.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const videoElement = document.getElementById("video");
        const qrResult = document.getElementById("qr-result");

        // Function to start the camera stream
        function startCamera() {
            navigator.mediaDevices
                .getUserMedia({ video: { facingMode: "environment" } }) // Use the rear-facing camera
                .then(function (stream) {
                    videoElement.srcObject = stream;
                    videoElement.play();
                    scanQRCode();
                })
                .catch(function (error) {
                    console.error("Error accessing the camera:", error);
                });
        }

        function destructure_QR_text(inputString) {
            var keyValuePairs = inputString.split('&');
            var result = {};

            for (var i = 0; i < keyValuePairs.length; i++) {
                var pair = keyValuePairs[i].split('=');
                var key = pair[0];
                var value = pair[1];

                // You can convert the value to a number if it's numeric
                if (!isNaN(value)) {
                    value = parseInt(value, 10);
                }

                result[key] = value;
            }

            return result;
        }

        const appendAlert = (message, type) => {
            const wrapper = document.createElement('div')
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                `   <div>${message}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('')
            qrResult.append(wrapper);
        }

        // Function to continuously scan for QR codes
        function scanQRCode(student_number) {
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            const videoWidth = videoElement.videoWidth;
            const videoHeight = videoElement.videoHeight;
            canvas.width = videoWidth;
            canvas.height = videoHeight;

            let timeoutId;

            const scanFrame = async (stud_num) => {
                context.drawImage(videoElement, 0, 0, videoWidth, videoHeight);
                const imageData = context.getImageData(0, 0, videoWidth, videoHeight);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                qrResult.innerHTML = '';

                if (code) {
                    const response = await fetch('/api/v1/qr/verify', {
                        mode: 'cors',
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            student_number : stud_num,
                            ...destructure_QR_text(code.data)
                        })
                    }); 

                    const result = response.json();
                    console.log(result);

                    if (result.success === 1) {
                        appendAlert('Successfully logged attendance!', 'success');
                    } else {
                        appendAlert('Invalid uuid.', 'danger');
                    }
                } else {
                    appendAlert(`Invalid QR code. ${code}`, 'warning');
                }
            };

            requestAnimationFrame(scanFrame(student_number));
        }


        // Start the camera when the page loads
        startCamera();

    });
</script>


{% endblock %}