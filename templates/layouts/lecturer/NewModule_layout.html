{% extends "base.html" %}

{% import "macros/__moduletable__ .html" as moduletable %}

{% block title %}
| Add New Module
{% endblock %}

{% block content %}
<div class="toast-container p-3 bottom-0 end-0" id="toast-area"></div>
<div class="container-lg h-100">
    <div id="alert-section"></div>
    <div class="d-flex flex-row">
        <button role="button" class="btn bg-transparent rounded border border-0" data-bs-toggle="modal"
            data-bs-target="#staticConfirmBack">
            <span class="material-symbols-outlined">
                arrow_back_ios_new
            </span>
        </button>
        <div class="col d-block pe-3 me-3">
            <p class="fs-3 fw-medium mb-0 text-center">
                New module
            </p>
            <div class="d-md-none d-flex justify-content-center w-100">
                <div class="border border-secondary border-1 w-50"></div>
            </div>
        </div>
    </div>
    <div class="container-fluid mt-2">
        <div class="d-flex flex-column">
            <div class="mb-3">
                <label for="moduleCode_field" class="form-label">Module code</label>
                <input type="text" class="form-control" id="moduleCode_field">
            </div>
            <div class="mb-3">
                <label for="moduleName_field" class="form-label">Module name</label>
                <input type="text" class="form-control" id="moduleName_field">
            </div>
        </div>
        <timetracker ref="tt"></timetracker>
        <div class="d-flex justify-content-center mt-4">
            <button role="button" id="add-module"
                class="btn bg-transparent rounded border border-1 d-flex align-items-center justify-content-center">
                <span class="material-symbols-outlined">add</span>
                Add new
            </button>
        </div>
    </div>
</div>
<div class="modal fade" id="staticConfirmBack" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Confirmation</h1>
            </div>
            <div class="modal-body">
                Unsaved changes will be lost.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary"
                    onclick="window.location.assign('/lecturer/manage')">Understood</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="/static/custom.js" type="text/javascript"></script>
<script>
    const saveEdit = document.getElementById("add-module");
    const moduleName = document.getElementById("moduleName_field");
    const moduleCode = document.getElementById("moduleCode_field");
    const timetrackerComponent = app._instance.refs.tt;
    const qrResult = document.getElementById("alert-section");

    const appendAlert = (message, type) => {
        const wrapper = document.querySelector("div#toast-area");
        wrapper.innerHTML = [
            `<div class="toast align-items-center bg-${type} text-white position-relative border-0"
                role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                        aria-label="Close"></button>
                </div>
            </div>`
        ].join('');
    }

    moduleName.addEventListener('change', () => moduleName.classList.remove("border", "border-1", "border-danger"));
    moduleCode.addEventListener('change', () => moduleCode.classList.remove("border", "border-1", "border-danger"));

    let modalClickOnce = 0;

    saveEdit.addEventListener('click', async () => {
        if (!moduleCode.value) {
            moduleCode.focus();
            moduleCode.classList.add("border", "border-1", "border-danger");
        }

        if (!moduleName.value) {
            if (moduleCode.value) moduleName.focus();
            return moduleName.classList.add("border", "border-1", "border-danger");
        }

        if (!timetrackerComponent.isAllFieldsValid())
            return;

        const formattedSlots = timetrackerComponent.formatTimeslots();
        const data = { module_code: moduleCode.value, module_name: moduleName.value, timeslots: formattedSlots };

        const res = await fetch('/api/v1/module/add', {
            mode: 'cors',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        }).then(result => result.json());

        if (res.success === -2) {
            appendAlert('Something went wrong. Try again later.', 'danger');
        } else if (res.success === -1) {
            appendAlert('Module code and/or Module name already in use.', 'danger');
        } else if (res.success === 1) {
            return window.location.assign('/lecturer/manage');
        }
        const toastItem = document.querySelector("div.toast");
        if (toastItem) {
            const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastItem);
            toastBootstrap.show()
        }
    });
</script>
{% endblock %}